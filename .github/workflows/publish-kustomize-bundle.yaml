name: Publish Kustomize Bundle

on:
  workflow_call:
    inputs:
      bundle-name:
        required: true
        type: string
        description: "The full name of the bundle that should be used, including the repository (e.g. `ghcr.io/datum-cloud/telemetry-services-operator/crds`)"
      bundle-path:
        required: true
        type: string
        description: "The path to the bundle that should be used, relative to the root of the repository (e.g. `config/crds`)"
      image-overlays:
        required: false
        type: string
        description: "Comma-separated list of overlay paths where images should be set (e.g. 'config/base,config/apiserver,config/controller-manager')"
        default: ""
      image-name:
        required: false
        type: string
        description: "The image name to set (e.g. 'ghcr.io/datum-cloud/datum-net')"
        default: ""
      debug:
        required: false
        type: boolean
        description: "Enable debug output and verification steps"
        default: false
    outputs:
      tags:
        description: "Generated tags for the bundle"
        value: ${{ jobs.publish-kustomize-bundle.outputs.tags }}
      labels:
        description: "Generated labels for the bundle"
        value: ${{ jobs.publish-kustomize-bundle.outputs.labels }}
      digest:
        description: "Digest of the published bundle"
        value: ${{ jobs.publish-kustomize-bundle.outputs.digest }}

jobs:
  publish-kustomize-bundle:
    permissions:
      id-token: write
      contents: read
      packages: write
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
      digest: ${{ steps.publish.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@v2.7.5
      
      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.bundle-name }}
          tags: |
            type=ref,event=pr,suffix=-{{commit_date 'YYYYMMDD-HHmmss'}},prefix=v0.0.0-
            type=ref,event=pr,prefix=v0.0.0-
            type=ref,event=branch,suffix=-{{commit_date 'YYYYMMDD-HHmmss'}},prefix=v0.0.0-
            type=ref,event=branch,prefix=v0.0.0-
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=semver,pattern=v{{major}}
            type=sha,prefix=v0.0.0-

      - name: Set Image Tags in Kustomize Overlays
        if: ${{ inputs.image-overlays != '' && inputs.image-name != '' }}
        run: |
          # Extract the first tag
          TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1 | cut -d':' -f2)
          
          echo "Will set image tag to: ${TAG}"
          echo "Image name: ${{ inputs.image-name }}"
          
          # Use absolute paths to avoid directory confusion
          WORKSPACE_ROOT="${GITHUB_WORKSPACE}"
          
          # Split the comma-separated overlay paths
          IFS=',' read -ra OVERLAYS <<< "${{ inputs.image-overlays }}"
          
          for overlay_path in "${OVERLAYS[@]}"; do
            overlay_path=$(echo "$overlay_path" | xargs)  # Trim whitespace
            FULL_PATH="${WORKSPACE_ROOT}/${overlay_path}"
            
            if [ -f "${FULL_PATH}/kustomization.yaml" ]; then
              echo "Setting image ${{ inputs.image-name }}:${TAG} in ${FULL_PATH}"
              
              pushd "${FULL_PATH}" > /dev/null
              kustomize edit set image "${{ inputs.image-name }}=${{ inputs.image-name }}:${TAG}"
              popd > /dev/null
              
              echo "Modified kustomization.yaml:"
              cat "${FULL_PATH}/kustomization.yaml"
            else
              echo "Error: ${FULL_PATH}/kustomization.yaml not found"
              exit 1
            fi
          done
          
          # CRITICAL: Ensure all filesystem operations are complete
          sync
          
          # Give the filesystem a moment to settle
          sleep 1
          
          echo "=== Final bundle structure ==="
          find "${{ inputs.bundle-path }}" -type f -o -type d | sort

      - name: Debug - Verify bundle structure before publish
        if: ${{ inputs.debug }}
        run: |
          echo "=== VERIFICATION: Bundle structure at ${{ inputs.bundle-path }} ==="
          echo "Absolute path: ${GITHUB_WORKSPACE}/${{ inputs.bundle-path }}"
          
          echo ""
          echo "Directory tree:"
          tree "${{ inputs.bundle-path }}" || ls -lR "${{ inputs.bundle-path }}"
          
          echo ""
          echo "File count:"
          find "${{ inputs.bundle-path }}" -type f | wc -l
          
          echo ""
          echo "Checking for expected directories:"
          for dir in base gateway; do
            if [ -d "${{ inputs.bundle-path }}/${dir}" ]; then
              echo "‚úÖ ${dir}/ exists with $(find ${{ inputs.bundle-path }}/${dir} -type f | wc -l) files"
            else
              echo "‚ùå ${dir}/ NOT FOUND"
            fi
          done

      - name: Publish Bundle (with timing analysis)
        id: publish
        run: |
          BUNDLE_PATH="${GITHUB_WORKSPACE}/${{ inputs.bundle-path }}"
          
          echo "Publishing from: ${BUNDLE_PATH}"
          
          DIGEST=""
          PUSH_COUNT=0
          
          while IFS= read -r tag; do
            PUSH_COUNT=$((PUSH_COUNT + 1))
            
            # Add delay between pushes (except for the first one)
            if [ ${PUSH_COUNT} -gt 1 ]; then
              echo ""
              echo "‚è±Ô∏è  Waiting 3 seconds before next push..."
              sleep 3
            fi
            
            tag_version="${tag#*:}"
            echo ""
            echo "=========================================="
            echo "Push #${PUSH_COUNT}: oci://${tag}"
            echo "=========================================="
            
            # Verify structure before EACH push (if debug is enabled)
            if [ "${{ inputs.debug }}" = "true" ]; then
              echo "üìÅ Directory structure before push #${PUSH_COUNT}:"
              find "${BUNDLE_PATH}" -type d | sort
              echo "üìÑ File count: $(find "${BUNDLE_PATH}" -type f | wc -l)"
            fi
            
            echo ""
            echo "üöÄ Pushing artifact..."
            RESULT=$(flux push artifact \
              "oci://${tag}" \
              --path="${BUNDLE_PATH}" \
              --source="https://github.com/${GITHUB_REPOSITORY}" \
              --revision="${tag_version}@sha1:$(git rev-parse HEAD)" \
              --output=json)

            CURRENT_DIGEST=$(echo "$RESULT" | jq -r '.digest')
            echo "‚úÖ Push #${PUSH_COUNT} complete"
            echo "   Digest: ${CURRENT_DIGEST}"
            
            echo ""
            echo "Full push result:"
            echo "${RESULT}" | jq '.'
            
          done < <(echo "${{ steps.meta.outputs.tags }}")

          echo ""
          echo "=========================================="
          echo "Summary"
          echo "=========================================="
          echo "Total pushes: ${PUSH_COUNT}"

          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
